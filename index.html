<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> â¤ï¸A+K | Travel Plan</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        #map { height: 400px; width: 100%; border-radius: 1.5rem; z-index: 1; border: 1px solid #e2e8f0; }
        .card-shadow { box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05); }
        [v-cloak] { display: none; }

        .day-nav { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        input[type="time"] { min-width: 105px !important; }
        .app-container { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; position: relative; }
    </style>
</head>
<body>

<div id="app" v-cloak class="app-container shadow-2xl">
    <div v-if="!isAuthorized" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center p-10 text-center">
        <h1 class="text-3xl font-black text-sky-600 mb-6">â¤ï¸ A+K Travel Planâ¤ï¸</h1>
        <div v-if="!currentUser">
            <button @click="login" class="bg-sky-600 text-white font-black py-4 px-8 rounded-2xl shadow-xl">ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</button>
        </div>
        <div v-else class="text-red-500 font-black">
            <p>æœªç²æˆæ¬Š: {{currentUser.email}}</p>
            <button @click="logout" class="mt-4 underline text-sm">ç™»å‡ºä¸¦åˆ‡æ›å¸³è™Ÿ</button>
        </div>
    </div>

    <div v-if="showModal && isAuthorized" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md flex items-center justify-center z-[100] p-6">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl space-y-6">

            <h2 class="text-2xl font-black text-center text-gray-800">ğŸŒ NEW TRIP ğŸŒ</h2>
            <div class="space-y-4">
                <input v-model="tempSetup.dest" placeholder="ç›®çš„åœ° (ä¾‹å¦‚: Tokyo)" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none border">
                <div class="bg-slate-50 p-4 rounded-xl space-y-3">
                    <div>
                        <label class="text-[10px] block text-gray-400 uppercase font-bold mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" v-model="tempSetup.start" class="w-full bg-white p-2 rounded-lg text-sm outline-none border">
                    </div>
                    <div>
                        <label class="text-[10px] block text-gray-400 uppercase font-bold mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" v-model="tempSetup.end" class="w-full bg-white p-2 rounded-lg text-sm outline-none border">
                    </div>
                </div>
            </div>
            <button @click="createNewTrip" class="w-full bg-sky-600 text-white font-black py-4 rounded-2xl shadow-xl">å»ºç«‹è¡Œç¨‹</button>
        </div>
    </div>

    <div v-if="tripData.setup && isAuthorized">
        <header class="bg-sky-600 text-white p-4 sticky top-0 z-50 shadow-lg rounded-b-[1.5rem]">

            <div class="flex justify-between items-center mb-3">
                <h1 class="font-black text-lg truncate">{{ tripData.setup.destination }}</h1>
                <div class="flex gap-2">
                    <button @click="exportToExcel" class="bg-white/20 p-2 rounded-full text-lg"><i class="ph ph-file-xls"></i></button>
                    <button @click="logout" class="bg-white/20 p-2 rounded-full text-lg"><i class="ph ph-sign-out"></i></button>
                </div>
            </div>
            <nav class="flex bg-black/10 p-1 rounded-2xl">
                <button v-for="m in menu" :key="m.id" @click="view = m.id" :class="view === m.id ? 'bg-white text-sky-600' : 'text-sky-100'" class="flex-1 py-1.5 rounded-xl transition-all flex justify-center text-xl">
                    <i :class="['ph-bold', m.icon]"></i>
                </button>
            </nav>
        </header>

        <main class="p-4 pb-24">
            <section v-show="view === 'plan'" class="space-y-4">
                <div class="day-nav gap-2 pb-2 scrollbar-hide">
                    <button v-for="(day, idx) in tripData.days" :key="idx" @click="currentDayIdx = idx" :class="currentDayIdx === idx ? 'bg-sky-600 text-white' : 'bg-gray-100 text-gray-400'" class="px-4 py-2 rounded-xl font-bold shrink-0 text-center">
                        D{{ idx + 1 }} <span class="text-[10px] block font-normal">{{formatDayDate(idx) }}</span>
                    </button>
                </div>

                <div v-if="tripData.days[currentDayIdx]" class="space-y-3">
                    <div class="bg-blue-50 p-3 rounded-2xl border border-blue-100 flex items-center gap-2">
                        <input v-model="tripData.days[currentDayIdx].city" @change="fetchWeatherByDay(currentDayIdx)" placeholder="ç›®çš„åœ°åŸå¸‚" class="flex-1 bg-white p-2 rounded-lg text-sm font-bold outline-none border min-w-0">
                        
                        <div v-if="tripData.days[currentDayIdx].weather" class="flex flex-col items-end pl-2 min-w-[70px]">

                            <div class="flex items-center justify-end gap-1 text-sky-600">
                                <i :class="['ph-duotone', tripData.days[currentDayIdx].weather.icon, 'text-2xl']"></i>
                                <span class="text-xl font-bold font-mono whitespace-nowrap">{{ tripData.days[currentDayIdx].weather.temp }}Â°</span>
                            </div>
                            <div class="text-[9px] text-slate-400 flex items-center gap-1 justify-end mt-0.5">
                                <i :class="tripData.days[currentDayIdx].weather.isForecast ? 'ph-bold ph-calendar' : 'ph-bold ph-map-pin'"></i>
                                {{ tripData.days[currentDayIdx].weather.label }}
                            </div>

                        </div>
                        <div v-else class="text-[10px] text-gray-300 font-bold px-2">è¼¸å…¥åŸå¸‚</div>
                    </div>

                    <div class="flex gap-2 items-center">
                        <input v-model="tripData.days[currentDayIdx].hotel" @change="forceSync" placeholder="ä¸‹æ¦»é…’åº—" class="flex-1 bg-orange-50 p-3 rounded-2xl text-sm font-bold outline-none border border-orange-100 min-w-0">
                        <button @click="openGoogleMap(tripData.days[currentDayIdx].hotel)" class="bg-orange-500 text-white p-3 rounded-2xl shadow-sm shrink-0"><i class="ph ph-map-pin"></i></button>
                    </div>


                    <div v-for="(item, i) in sortedItems" :key="i" class="bg-white p-3 rounded-2xl border border-gray-100 card-shadow space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="time" v-model="item.time" @change="forceSync" class="font-black text-sky-600 text-base outline-none w-24 shrink-0">
                            <input v-model="item.activity" @change="forceSync" placeholder="è¡Œç¨‹æ´»å‹•" class="flex-1 font-bold text-gray-700 text-sm outline-none min-w-0">
                            <button @click="removeItemByObject(item)" class="text-gray-300 shrink-0"><i class="ph ph-x-circle text-lg"></i></button>
                        </div>

                        <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
                            <input v-model="item.location" @change="forceSync" placeholder="åœ°é»åç¨±" class="flex-1 bg-transparent text-xs text-gray-500 outline-none min-w-0">
                            <button @click="openGoogleMap(item.location)" class="text-sky-500 shrink-0"><i class="ph ph-map-pin"></i></button>
                        </div>
                    </div>
                    <button @click="addItem" class="w-full py-4 border-2 border-dashed border-gray-200 rounded-2xl text-gray-400 font-bold text-sm">+ æ–°å¢é …ç›®</button>
                </div>
            </section>

            <section v-show="view === 'transport'" class="space-y-4">
                <div v-for="(t, i) in tripData.trans" :key="i" class="bg-white p-4 rounded-2xl border card-shadow space-y-3">
                    <div class="flex justify-between items-center">
                        <select v-model="t.type" @change="forceSync" class="font-black text-sky-600 outline-none">
                            <option>èˆªç­</option><option>ç«è»Š/é«˜éµ</option><option>åœ°éµ/é›»è»Š</option><option>å·´å£«</option><option>çš„å£«/Uber</option><option>å…¶ä»–</option>
                        </select>
                        <button @click="tripData.trans.splice(i,1); forceSync()" class="text-red-300 text-sm">åˆªé™¤</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input v-model="t.no" @change="forceSync" placeholder="ç­æ¬¡" class="bg-gray-50 p-2 rounded-lg text-xs outline-none font-bold">
                        <input v-model="t.cost" @change="forceSync" placeholder="è²»ç”¨" class="bg-gray-50 p-2 rounded-lg text-xs outline-none font-bold">
                        <input v-model="t.time" @change="forceSync" placeholder="æ™‚é–“" class="bg-gray-50 p-2 rounded-lg text-xs outline-none font-bold">
                        <input v-model="t.duration" @change="forceSync" placeholder="æ™‚é•·" class="bg-gray-50 p-2 rounded-lg text-xs outline-none font-bold">
                    </div>
                </div>
                <button @click="addTransport" class="w-full py-4 bg-sky-600 text-white rounded-2xl font-bold">+ æ–°å¢äº¤é€š</button>
            </section>

            <section v-show="view === 'money'" class="space-y-4">
                <div class="bg-orange-50 p-5 rounded-[2rem] text-center border border-orange-100">
                    <div class="text-[10px] text-orange-400 font-bold mb-1">Total HKD Expenses</div>
                    <div class="text-3xl font-black text-orange-600">HK$ {{ totalHKDCost }}</div>
                </div>
                <div class="bg-white p-4 rounded-2xl border space-y-3 shadow-sm">
                    <div class="flex items-center gap-2">
                        <select v-model="newExpense.type" class="w-24 bg-gray-100 p-2 rounded-lg text-xs font-bold shrink-0">
                            <option>é¤é£²</option><option>äº¤é€š</option><option>è³¼ç‰©</option><option>ä½å®¿</option><option>å…¶ä»–</option>
                        </select>
                        <div class="flex flex-1 gap-1 min-w-0">
                            <input v-model="newExpense.currency" class="w-12 bg-gray-100 p-2 rounded-lg text-[10px] font-bold text-center shrink-0" placeholder="å¹£åˆ¥">
                            <input v-model.number="newExpense.amount" type="number" class="flex-1 bg-gray-100 p-2 rounded-lg text-xs font-bold text-right min-w-0" placeholder="é‡‘é¡">
                        </div>

                    </div>
                    <div class="flex gap-2">
                        <input v-model="newExpense.item" placeholder="æè¿°" class="flex-1 bg-gray-50 p-2 rounded-lg text-sm border min-w-0">
                        <button @click="addNewExpense" class="bg-sky-600 text-white px-4 py-2 rounded-lg font-bold shrink-0">è¨˜éŒ„</button>
                    </div>
                </div>
                <div v-for="(exp, i) in tripData.expenses" :key="i" class="bg-white p-3 rounded-xl border flex items-center justify-between">
                    <div class="min-w-0 flex-1 pr-2">
                        <div class="text-[9px] font-black text-gray-400 uppercase">{{ exp.type }}</div>
                        <div class="text-sm font-bold truncate">{{ exp.item }}</div>
                    </div>
                    <div class="text-right shrink-0">
                        <div class="text-[9px] text-gray-400">{{ exp.amount }} {{ exp.currency }}</div>
                        <div class="text-sm font-black text-sky-700">HK$ {{ Math.round(exp.amount * exp.rate) }}</div>
                    </div>
                </div>
            </section>
        </main>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBcCI6Qic0_3tXz6fKobZ6Mj9p9ZCNlzZk", 
        authDomain: "aktrips-f3098.firebaseapp.com", 
        databaseURL: "https://aktrips-f3098-default-rtdb.firebaseio.com",
        projectId: "aktrips-f3098", 
        storageBucket: "aktrips-f3098.firebasestorage.app", 
        appId: "1:534453459530:web:14d840aaa533e6e6e9e4b3"

    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getDatabase(fbApp);
    const auth = getAuth(fbApp);
    const provider = new GoogleAuthProvider();

    const { createApp, ref: vueRef, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const whitelist = ['orkelvinh@gmail.com', 'akwangel@gmail.com', 'iamhaukelvin@gmail.com']; 
            const isAuthorized = vueRef(false);
            const currentUser = vueRef(null);

            const view = vueRef('plan');
            const currentDayIdx = vueRef(0);
            const tripId = vueRef(null);
            const showModal = vueRef(false);
            const tempSetup = vueRef({ dest: '', start: '', end: '' });
            const tripData = vueRef({ setup: null, days: [], trans: [], lists: { food: [], shopping: [] }, expenses: [] });
            const newExpense = vueRef({ type: 'é¤é£²', currency: 'JPY', item: '', amount: null, rate: 0.052 });

            const menu = [
                {id:'plan', icon:'ph-calendar'}, {id:'map', icon:'ph-map-pin'}, 
                {id:'transport', icon:'ph-train'}, {id:'lists', icon:'ph-shopping-cart'}, 
                {id:'money', icon:'ph-currency-dollar'}
            ];


            // --- å¤©æ°£åœ–ç¤ºè½‰æ›é‚è¼¯ (Open-Meteo) ---
            const getWeatherIcon = (code) => {
                const icons = {
                    0: 'ph-sun', 1: 'ph-cloud-sun', 2: 'ph-cloud-sun', 3: 'ph-cloud',
                    45: 'ph-cloud-fog', 48: 'ph-cloud-fog',
                    51: 'ph-cloud-rain', 53: 'ph-cloud-rain', 55: 'ph-cloud-rain',
                    61: 'ph-cloud-rain', 63: 'ph-cloud-rain', 65: 'ph-cloud-rain',
                    71: 'ph-cloud-snow', 73: 'ph-cloud-snow', 75: 'ph-cloud-snow',
                    95: 'ph-cloud-lightning'
                };
                return icons[code] || 'ph-cloud';
            };

            const fetchWeatherByDay = async (idx) => {
                const day = tripData.value.days[idx];
                if (!day.city) return;
                
                try {
                    // 1. Nominatim åœ°ç†ç·¨ç¢¼
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(day.city)}&limit=1`);
                    const geoData = await geoRes.json();
                    if(!geoData?.[0]) return;
                    const { lat, lon } = geoData[0];

                    // 2. Open-Meteo é å ± (16å¤©)
                    const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max&timezone=auto&forecast_days=16`);
                    const wData = await wRes.json();

                    // 3. åˆ¤æ–·è¡Œç¨‹æ—¥æœŸæ˜¯å¦åœ¨ 16 å¤©é å ±ç¯„åœå…§
                    const tripDateStr = formatDayDateRaw(idx); // YYYY-MM-DD
                    const forecastIdx = wData.daily.time.indexOf(tripDateStr);

                    if (forecastIdx !== -1) {
                        // é¡¯ç¤ºè©²æ—¥é å ±
                        day.weather = {
                            temp: Math.round(wData.daily.temperature_2m_max[forecastIdx]),
                            icon: getWeatherIcon(wData.daily.weathercode[forecastIdx]),
                            label: 'Forecast',
                            isForecast: true
                        };
                    } else {
                        // é¡¯ç¤ºç›®å‰å¤©æ°£
                        day.weather = {
                            temp: Math.round(wData.current_weather.temperature),
                            icon: getWeatherIcon(wData.current_weather.weathercode),
                            label: 'Current',
                            isForecast: false
                        };
                    }
                    forceSync();
                } catch (e) { console.error("Weather error", e); }
            };


            const formatDayDateRaw = (idx) => {
                const d = new Date(tripData.value.setup.startDate);
                d.setDate(d.getDate() + idx);
                return d.toISOString().split('T')[0];
            };

            const formatDayDate = (idx) => {
                if (!tripData.value.setup?.startDate) return '';
                const d = new Date(tripData.value.setup.startDate);
                d.setDate(d.getDate() + idx);
                return (d.getMonth() + 1) + '/' + d.getDate();
            };

            // --- æ ¸å¿ƒåˆå§‹åŒ–èˆ‡ Firebase é‚è¼¯ ---
            onMounted(() => {

                onAuthStateChanged(auth, (user) => {
                    if (user && whitelist.map(e => e.toLowerCase()).includes(user.email.toLowerCase())) {
                        currentUser.value = user; isAuthorized.value = true; initData();
                    } else { isAuthorized.value = false; currentUser.value = user; }
                });
            });

            const initData = () => {
                const id = new URLSearchParams(window.location.search).get('id');
                if (!id) { showModal.value = true; return; }
                tripId.value = id;
                onValue(ref(db, 'trips/' + id), (snap) => {

                    const data = snap.val();
                    if (data) {
                        tripData.value = data;
                        if(view.value === 'map') nextTick(() => initMap());
                    } else { showModal.value = true; }
                });
            };

            const createNewTrip = () => {
                if (!tempSetup.value.dest || !tempSetup.value.start || !tempSetup.value.end) return alert('å¡«å¯«å®Œæ•´');
                const start = new Date(tempSetup.value.start), end = new Date(tempSetup.value.end);
                const diff = Math.ceil((end - start) / (86400000)) + 1;
                const id = 'trip_' + Date.now();

                const newTrip = {
                    setup: { destination: tempSetup.value.dest, startDate: tempSetup.value.start, endDate: tempSetup.value.end },
                    days: Array.from({ length: diff }, () => ({ city: tempSetup.value.dest, hotel: '', items: [] })),
                    trans: [], lists: { food: [], shopping: [] }, expenses: []
                };
                set(ref(db, 'trips/' + id), newTrip).then(() => window.location.href = window.location.pathname + '?id=' + id);
            };

            const forceSync = () => tripId.value && update(ref(db, 'trips/' + tripId.value), JSON.parse(JSON.stringify(tripData.value)));

            // --- åœ°åœ–é‚è¼¯ ---
            let mapInstance = null, markerGroup = null;
            const initMap = () => {
                if (mapInstance) return updateMarkers();
                mapInstance = L.map('map', { zoomControl: false }).setView([35.68, 139.76], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                markerGroup = L.layerGroup().addTo(mapInstance);
                updateMarkers();
            };

            const updateMarkers = async () => {
                if (!markerGroup) return;
                markerGroup.clearLayers();
                const locs = dayLocations.value, bounds = [];
                for (const loc of locs) {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}`);
                        const d = await res.json();
                        if (d?.[0]) {
                            const latlng = [d[0].lat, d[0].lon];
                            L.marker(latlng).addTo(markerGroup).bindPopup(loc);
                            bounds.push(latlng);
                        }
                    } catch (e) {}
                }
                if (bounds.length > 0) mapInstance.fitBounds(bounds, { padding: [30, 30] });
            };

            // --- å…¶ä»–åŠŸèƒ½å‡½æ•¸ ---
            const sortedItems = computed(() => (tripData.value.days[currentDayIdx.value]?.items || []).sort((a,b)=>(a.time||'00:00').localeCompare(b.time||'00:00')));
            const dayLocations = computed(() => {
                const d = tripData.value.days[currentDayIdx.value];
                const l = d?.items ? d.items.map(i=>i.location).filter(x=>x) : [];
                if(d?.hotel) l.unshift(d.hotel);
                return [...new Set(l)];
            });

            const addItem = () => {
                if(!

tripData.value.days[currentDayIdx.value].items) tripData.value.days[currentDayIdx.value].items = [];
                tripData.value.days[currentDayIdx.value].items.push({ time: '12:00', activity: '', location: '' });
                forceSync();
            };
            const removeItemByObject = (item) => {
                const idx = tripData.value.days[currentDayIdx.value].items.indexOf(item);
                tripData.value.days[currentDayIdx.value].items.splice(idx,1);
                forceSync();
            };
            const addNewExpense = () => {

                if(!newExpense.value.amount) return;
                tripData.value.expenses.unshift({...newExpense.value});
                newExpense.value.item = ''; newExpense.value.amount = null;
                forceSync();
            };
            const totalHKDCost = computed(() => (tripData.value.expenses || []).reduce((s,e)=>s+(e.amount*e.rate),0).toLocaleString());
            const login = () => signInWithPopup(auth, provider);
            const logout = () => signOut(auth).then(()=>window.location.reload());
            const openGoogleMap = (q) => q && window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const addTransport = () => { tripData.value.trans.push({type:'èˆªç­',no:'',cost:'',time:'',duration:''}); forceSync(); };

            watch(view, (v) => v === 'map' && nextTick(()=>initMap()));
            watch(currentDayIdx, () => view.value === 'map' && updateMarkers());

            return {
                view, menu, currentDayIdx, tripData, totalHKDCost, formatDayDate, newExpense, isAuthorized, currentUser, dayLocations, sortedItems,
                showModal, tempSetup, createNewTrip, login, logout, addItem, removeItemByObject, addTransport, addNewExpense, openGoogleMap, forceSync, fetchWeatherByDay

            };
        }
    }).mount('#app');
</script>
</body>
</html>
